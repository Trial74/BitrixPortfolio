!function(t){t.JCCatalogProductSubscribeList||(t.JCCatalogProductSubscribeList=function(t){if(this.productType=0,this.showAbsent=!0,this.showSkuProps=!1,this.visual={ID:"",PICT_ID:"",DELETE_SUBSCRIBE_ID:""},this.product={id:0,name:"",pict:{},listSubscribeId:{}},this.defaultPict={pict:null},this.offers=[],this.offerNum=0,this.treeProps=[],this.obTreeRows=[],this.obProduct=null,this.obPict=null,this.obTree=null,this.deleteSubscribeBtn=null,this.obSkuProps=null,this.containerHeight=0,this.errorCode=0,this.ajaxUrl="/bitrix/components/bitrix/catalog.product.subscribe.list/ajax.php","object"==typeof t){if(this.productType=parseInt(t.PRODUCT_TYPE,10),this.showAbsent=t.SHOW_ABSENT,this.showSkuProps=!!t.SHOW_SKU_PROPS,this.notifyUser=Boolean(t.NOTIFY_USER),this.notifyPopupTitle=t.NOTIFY_POPUP_TITLE,this.notifySuccess=Boolean(t.NOTIFY_SUCCESS),this.notifyMessage=t.NOTIFY_MESSAGE,this.notifyUser)return void BX.ready(BX.delegate(this.showAlertNotifyingUser,this));switch(this.visual=t.VISUAL,this.visual.DELETE_SUBSCRIBE_ID&&(this.deleteSubscribeBtn=BX(this.visual.DELETE_SUBSCRIBE_ID),this.deleteSubscribeBtn&&BX.bind(this.deleteSubscribeBtn,"click",BX.delegate(this.deleteSubscribe,this)),this.product.listSubscribeId=t.PRODUCT.LIST_SUBSCRIBE_ID),this.productType){case 1:case 2:t.PRODUCT&&"object"==typeof t.PRODUCT?(this.product.id=t.PRODUCT.ID,this.product.name=t.PRODUCT.NAME,this.product.pict=t.PRODUCT.PICT):this.errorCode=-1;break;case 3:t.PRODUCT&&"object"==typeof t.PRODUCT&&(this.product.id=t.PRODUCT.ID,this.product.name=t.PRODUCT.NAME),t.OFFERS&&BX.type.isArray(t.OFFERS)?(this.offers=t.OFFERS,this.offerNum=0,t.OFFER_SELECTED&&(this.offerNum=parseInt(t.OFFER_SELECTED,10)),isNaN(this.offerNum)&&(this.offerNum=0),t.TREE_PROPS&&(this.treeProps=t.TREE_PROPS),t.DEFAULT_PICTURE&&(this.defaultPict.pict=t.DEFAULT_PICTURE.PICTURE)):this.errorCode=-1;break;default:this.errorCode=-1}}0===this.errorCode&&BX.ready(BX.delegate(this.Init,this))},t.JCCatalogProductSubscribeList.prototype.Init=function(){var e="",s=null;if(this.obProduct=BX(this.visual.ID),this.obProduct||(this.errorCode=-1),this.obPict=BX(this.visual.PICT_ID),this.obPict||(this.errorCode=-2),3===this.productType&&this.visual.TREE_ID){this.obTree=BX(this.visual.TREE_ID),this.obTree||(this.errorCode=-256),e=this.visual.TREE_ITEM_ID;for(var i=0;i<this.treeProps.length;i++)if(this.obTreeRows[i]={LIST:BX(e+this.treeProps[i].ID+"_list"),CONT:BX(e+this.treeProps[i].ID+"_cont")},!this.obTreeRows[i].LIST||!this.obTreeRows[i].CONT){this.errorCode=-512;break}}if(0===this.errorCode){switch(this.productType){case 1:break;case 3:if((s=BX.findChildren(this.obTree,{tagName:"li"},!0))&&0<s.length)for(i=0;i<s.length;i++)BX.bind(s[i],"click",BX.delegate(this.SelectOfferProp,this));this.SetCurrent()}this.containerHeight=parseInt(this.obProduct.offsetHeight,10),isNaN(this.containerHeight)&&(this.containerHeight=0),this.setHeight(),BX.bind(t,"resize",BX.delegate(this.checkHeight,this)),BX.bind(this.obProduct,"mouseover",BX.delegate(this.setHeight,this)),BX.bind(this.obProduct,"mouseout",BX.delegate(this.clearHeight,this))}},t.JCCatalogProductSubscribeList.prototype.SelectOfferProp=function(){var t=0,e=[],s=null,i=BX.proxy_context;if(i&&i.hasAttribute("data-treevalue")&&(e=i.getAttribute("data-treevalue").split("_"),this.SearchOfferPropIndex(e[0],e[1])&&(s=BX.findChildren(i.parentNode,{tagName:"li"},!1))&&0<s.length))for(t=0;t<s.length;t++)s[t].getAttribute("data-onevalue")===e[1]?BX.addClass(s[t],"bx_active"):BX.removeClass(s[t],"bx_active")},t.JCCatalogProductSubscribeList.prototype.SearchOfferPropIndex=function(t,e){var s,i,r="",o=!1,h=[],a=[],l=-1,c={},u=[];for(s=0;s<this.treeProps.length;s++)if(this.treeProps[s].ID===t){l=s;break}if(-1<l){for(s=0;s<l;s++)c[r="PROP_"+this.treeProps[s].ID]=this.selectedValues[r];if(r="PROP_"+this.treeProps[l].ID,!(o=this.GetRowValues(c,r)))return!1;if(!BX.util.in_array(e,o))return!1;for(c[r]=e,s=l+1;s<this.treeProps.length;s++){if(r="PROP_"+this.treeProps[s].ID,!(o=this.GetRowValues(c,r)))return!1;if(a=[],this.showAbsent)for(h=[],u=[],u=BX.clone(c,!0),i=0;i<o.length;i++)u[r]=o[i],a[a.length]=o[i],this.GetCanBuy(u)&&(h[h.length]=o[i]);else h=o;this.selectedValues[r]&&BX.util.in_array(this.selectedValues[r],h)?c[r]=this.selectedValues[r]:this.showAbsent?c[r]=h.length>0?h[0]:a[0]:c[r]=h[0],this.UpdateRow(s,c[r],o,h)}this.selectedValues=c,this.ChangeInfo()}return!0},t.JCCatalogProductSubscribeList.prototype.GetRowValues=function(t,e){var s,i=0,r=[],o=!1,h=!0;if(0===t.length){for(i=0;i<this.offers.length;i++)BX.util.in_array(this.offers[i].TREE[e],r)||(r[r.length]=this.offers[i].TREE[e]);o=!0}else for(i=0;i<this.offers.length;i++){for(s in h=!0,t)if(t[s]!==this.offers[i].TREE[s]){h=!1;break}h&&(BX.util.in_array(this.offers[i].TREE[e],r)||(r[r.length]=this.offers[i].TREE[e]),o=!0)}return!!o&&r},t.JCCatalogProductSubscribeList.prototype.GetCanBuy=function(t){var e,s=0,i=!1,r=!0;for(s=0;s<this.offers.length;s++){for(e in r=!0,t)if(t[e]!==this.offers[s].TREE[e]){r=!1;break}if(r&&this.offers[s].CAN_BUY){i=!0;break}}return i},t.JCCatalogProductSubscribeList.prototype.UpdateRow=function(t,e,s,i){var r=0,o=0,h="",a=0,l={},c=!1,u=(this.treeEnableArrow,this.treeEnableArrow,null);if(-1<t&&t<this.obTreeRows.length&&(u=BX.findChildren(this.obTreeRows[t].LIST,{tagName:"li"},!1))&&0<u.length)for(a=s.length,this.treeRowShowSize<a,l={style:{}},r=0;r<u.length;r++)c=(h=u[r].getAttribute("data-onevalue"))===e,l.style.display="none",BX.util.in_array(h,s)&&(l.style.display="",c&&o,o++),BX.adjust(u[r],l),c?BX.addClass(u[r],"bx_active"):BX.removeClass(u[r],"bx_active")},t.JCCatalogProductSubscribeList.prototype.ChangeInfo=function(){var t,e=0,s=-1,i=!0;for(e=0;e<this.offers.length;e++){for(t in i=!0,this.selectedValues)if(this.selectedValues[t]!==this.offers[e].TREE[t]){i=!1;break}if(i){s=e;break}}-1<s&&(this.obPict&&(this.obPictImg=BX.findChild(this.obPict,{tagName:"IMG"},!0,!1),this.obPictImg&&(this.offers[s].PREVIEW_PICTURE?BX.adjust(this.obPictImg,{props:{src:this.offers[s].PREVIEW_PICTURE.SRC,width:this.offers[s].PREVIEW_PICTURE.WIDTH,height:this.offers[s].PREVIEW_PICTURE.HEIGHT}}):BX.adjust(this.obPictImg,{props:{src:this.defaultPict.pict.SRC,width:this.defaultPict.pict.WIDTH,height:this.defaultPict.pict.HEIGHT}}))),this.showSkuProps&&this.obSkuProps&&BX.adjust(this.obSkuProps,{style:{display:"none"},html:""}),this.offerNum=s)},t.JCCatalogProductSubscribeList.prototype.SetCurrent=function(){var t=0,e=0,s=[],i="",r=!1,o={},h=[],a=this.offers[this.offerNum].TREE;for(t=0;t<this.treeProps.length&&(i="PROP_"+this.treeProps[t].ID,r=this.GetRowValues(o,i));t++){if(BX.util.in_array(a[i],r)?o[i]=a[i]:(o[i]=r[0],this.offerNum=0),this.showAbsent)for(s=[],h=[],h=BX.clone(o,!0),e=0;e<r.length;e++)h[i]=r[e],this.GetCanBuy(h)&&(s[s.length]=r[e]);else s=r;this.UpdateRow(t,o[i],r,s)}this.selectedValues=o,this.ChangeInfo()},t.JCCatalogProductSubscribeList.prototype.checkHeight=function(){this.containerHeight=parseInt(this.obProduct.offsetHeight,10),isNaN(this.containerHeight)&&(this.containerHeight=0)},t.JCCatalogProductSubscribeList.prototype.setHeight=function(){0<this.containerHeight&&BX.adjust(this.obProduct,{style:{height:this.containerHeight+"px"}})},t.JCCatalogProductSubscribeList.prototype.clearHeight=function(){BX.adjust(this.obProduct,{style:{height:"auto"}})},t.JCCatalogProductSubscribeList.prototype.deleteSubscribe=function(){var e;switch(this.productType){case 1:case 2:e=this.product.id;break;case 3:var s,i,r;if(!this.offers.length){e=this.product.id;break}for(s=0;s<this.offers.length;s++){for(i in r=!0,this.selectedValues)if(this.selectedValues[i]!==this.offers[s].TREE[i]){r=!1;break}if(r){s,e=this.offers[s].ID;break}}}e&&this.product.listSubscribeId.hasOwnProperty(e)&&BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),deleteSubscribe:"Y",itemId:e,listSubscribeId:this.product.listSubscribeId[e]},onsuccess:BX.delegate(function(e){e.success?t.location.reload():this.showAlertWithAnswer({status:"error",message:e.message})},this)})},t.JCCatalogProductSubscribeList.prototype.showAlertWithAnswer=function(t){var e;(t=t||{}).message||("success"==t.status?(t.message=BX.message("CPSL_STATUS_SUCCESS"),e="alert alert-success"):(t.message=BX.message("CPSL_STATUS_ERROR"),e="alert alert-error")),this.showAlertBlock(t.message,e)},t.JCCatalogProductSubscribeList.prototype.showAlertNotifyingUser=function(){var t;t=this.notifySuccess?"alert alert-success":"alert alert-error",this.showAlertBlock(this.notifyMessage,t)},t.JCCatalogProductSubscribeList.prototype.showAlertBlock=function(t,e){t=t||"",e=e||"",BX("alertMessage")&&t&&e&&(BX("alertMessage").appendChild(BX.create("DIV",{props:{className:e,style:"display: block;"},text:t})),BX.addClass(BX("alertMessage"),"bx_subscribe_alert"))})}(window);