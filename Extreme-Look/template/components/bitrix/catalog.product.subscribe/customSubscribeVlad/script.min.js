!function(t){if(!t.JCCatalogProductSubscribe){var e=function(t){e.superclass.constructor.apply(this,arguments),this.buttonNode=BX.create("button",{text:t.text,attrs:{className:t.className},events:this.contextEvents})};BX.extend(e,BX.PopupWindowButton),t.JCCatalogProductSubscribe=function(t){this.buttonId=t.buttonId,this.buttonClass=t.buttonClass,this.productId=t.productId,this.jsObject=t.jsObject,this.ajaxUrl="/bitrix/components/bitrix/catalog.product.subscribe/ajax.php",this.ajaxPath=t.ajaxPath,this.alreadySubscribed=t.alreadySubscribed,this.urlListSubscriptions=t.urlListSubscriptions,this.listOldItemId={},this.landingId=t.landingId,this.elemButtonSubscribe=null,this.elemPopupWin=null,this._elemButtonSubscribeClickHandler=BX.delegate(this.subscribe,this),this._elemHiddenClickHandler=BX.delegate(this.checkSubscribe,this),BX.ready(BX.delegate(this.init,this))},t.JCCatalogProductSubscribe.prototype.init=function(){this.buttonId&&(this.elemButtonSubscribe=BX(this.buttonId),this.elemHiddenSubscribe=BX(this.buttonId+"_hidden")),this.elemButtonSubscribe&&BX.bind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler),this.elemHiddenSubscribe&&BX.bind(this.elemHiddenSubscribe,"click",this._elemHiddenClickHandler),this.setButton(this.alreadySubscribed),BX.ajax({url:this.ajaxPath,method:"POST",dataType:"json",timeout:60,data:{action:"checkAlreadySubscribed",productId:this.productId},onsuccess:BX.delegate(function(t){this.setButton(t.alreadySubscribed)},this)})},t.JCCatalogProductSubscribe.prototype.checkSubscribe=function(){this.elemHiddenSubscribe&&this.elemButtonSubscribe&&(this.listOldItemId.hasOwnProperty(this.elemButtonSubscribe.dataset.item)?this.setButton(!0):BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),checkSubscribe:"Y",itemId:this.elemButtonSubscribe.dataset.item},onsuccess:BX.delegate(function(t){t.subscribe?(this.setButton(!0),this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0):this.setButton(!1)},this)}))},t.JCCatalogProductSubscribe.prototype.subscribe=function(){if(this.elemButtonSubscribe=BX.proxy_context,!this.elemButtonSubscribe)return!1;BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),subscribe:"Y",itemId:this.elemButtonSubscribe.dataset.item,siteId:BX.message("SITE_ID"),landingId:this.landingId},onsuccess:BX.delegate(function(t){if(t.success)this.createSuccessPopup(t),this.setButton(!0),this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0;else if(t.contactFormSubmit){this.initPopupWindow(),this.elemPopupWin.setTitleBar(BX.message("CPST_SUBSCRIBE_POPUP_TITLE"));var s=this.createContentForPopup(t);this.elemPopupWin.setContent(s),this.elemPopupWin.setButtons([new e({text:BX.message("CPST_SUBSCRIBE_BUTTON_NAME"),className:"btn btn-buy",events:{click:BX.delegate(function(){if(!this.validateContactField(t.contactTypeData))return!1;BX.ajax.submitAjax(s,{method:"POST",url:this.ajaxUrl,processData:!0,onsuccess:BX.delegate(function(t){if((t=BX.parseJSON(t,{})).success)this.createSuccessPopup(t),this.setButton(!0),this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0;else if(t.error){t.hasOwnProperty("setButton")&&(this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0,this.setButton(!0));var e=BX.create("span",{props:{className:"alert alert-error alert-show"},html:t.hasOwnProperty("typeName")?t.message.replace("USER_CONTACT",t.typeName):t.message});BX("bx-catalog-subscribe-form-notify").innerHTML="",BX("bx-catalog-subscribe-form-notify").appendChild(e)}},this)})},this)}})]),this.elemPopupWin.show()}else t.error&&(t.hasOwnProperty("setButton")&&(this.listOldItemId[this.elemButtonSubscribe.dataset.item]=!0,this.setButton(!0)),this.showWindowWithAnswer({status:"error",message:t.message}))},this)})},t.JCCatalogProductSubscribe.prototype.validateContactField=function(t){var e=BX.findChildren(BX("bx-catalog-subscribe-form"),{tag:"input",attribute:{id:"userContact"}},!0);if(!e.length||"object"!=typeof t){var s=BX.create("span",{props:{className:"alert alert-error alert-show"},html:BX.message("CPST_SUBSCRIBE_VALIDATE_UNKNOW_ERROR")});return BX("bx-catalog-subscribe-form-notify").innerHTML="",BX("bx-catalog-subscribe-form-notify").appendChild(s),!1}for(var a,i,o,c=[],r=[],n=0;n<e.length;n++)a=e[n].getAttribute("data-id"),i=e[n].value,(o=BX("bx-contact-use-"+a))&&"N"==o.value?r.push(!0):i.length||c.push(BX.message("CPST_SUBSCRIBE_VALIDATE_ERROR_EMPTY_FIELD").replace("#FIELD#",t[a].contactLable));if(e.length==r.length){s=BX.create("span",{props:{className:"alert alert-error alert-show"},html:BX.message("CPST_SUBSCRIBE_VALIDATE_ERROR")});return BX("bx-catalog-subscribe-form-notify").innerHTML="",BX("bx-catalog-subscribe-form-notify").appendChild(s),!1}if(c.length){s=BX.create("span",{props:{className:"alert alert-error alert-show"},style:{display:"block"},html:c.join("<br />")});return BX("bx-catalog-subscribe-form-notify").innerHTML="",BX("bx-catalog-subscribe-form-notify").appendChild(s),!1}return!0},t.JCCatalogProductSubscribe.prototype.reloadCaptcha=function(){var t=BX("bx-catalog-subscribe-form"),e=BX.findChild(t,{attribute:{name:"captcha_sid"}},!0,!1),s=BX.findChild(t,{attribute:{id:"captcha_img"}},!0,!1),a=BX.findChild(t,{attribute:{name:"captcha_word"}},!0,!1);BX.ajax.get(this.ajaxUrl+"?reloadCaptcha=Y","",function(t){e&&(e.value=t),s&&(s.src="/bitrix/tools/captcha.php?captcha_sid="+t),a&&(a.value="")})},t.JCCatalogProductSubscribe.prototype.createContentForPopup=function(t){if(!t.hasOwnProperty("contactTypeData"))return null;var e=t.contactTypeData,s=Object.keys(e).length,a="",i="N",o=document.createDocumentFragment();for(var c in o.appendChild(BX.create("DIV",{props:{id:"bx-catalog-subscribe-form-notify",className:"bx-catalog-subscribe-form-notify"}})),s>1&&(i="Y",a="display: none;",o.appendChild(BX.create("DIV",{props:{className:"bx-catalog-subscribe-form-caption"},text:BX.message("CPST_SUBSCRIBE_MANY_CONTACT_NOTIFY")}))),e)s>1&&o.appendChild(BX.create("div",{props:{className:"form-group"},children:[BX.create("DIV",{props:{className:"checkbox"},children:[BX.create("input",{props:{type:"hidden",id:"bx-contact-use-"+c,name:"contact["+c+"][use]",value:"N"}}),BX.create("input",{props:{id:"bx-contact-checkbox-"+c,type:"checkbox"}}),BX.create("label",{attrs:{onclick:this.jsObject+".selectContactType("+c+", event);"},children:[BX.create("SPAN",{props:{className:"check-cont"},children:[BX.create("SPAN",{props:{className:"check"},children:[BX.create("I",{props:{className:"icon-ok-b"}})]})]}),BX.create("SPAN",{props:{className:"check-title"},text:e[c].contactLable})]})]})]})),o.appendChild(BX.create("DIV",{props:{id:"bx-catalog-subscribe-form-container-"+c,className:"form-group",style:a},children:[BX.create("input",{props:{id:"userContact",className:"form-control",type:"text",name:"contact["+c+"][user]"},attrs:{"data-id":c,placeholder:e[c].contactLable}})]}));t.hasOwnProperty("captchaCode")&&o.appendChild(BX.create("DIV",{props:{className:"form-group captcha"},children:[BX.create("DIV",{props:{className:"pic"},children:[BX.create("img",{props:{id:"captcha_img",src:"/bitrix/tools/captcha.php?captcha_sid="+t.captchaCode},attrs:{width:"100",height:"36",alt:"CAPTCHA",onclick:this.jsObject+".reloadCaptcha();"}})]}),BX.create("input",{props:{id:"captcha_word",className:"form-control",type:"text",name:"captcha_word"},attrs:{maxlength:"5",placeholder:BX.message("CPST_ENTER_WORD_PICTURE")}}),BX.create("input",{props:{type:"hidden",id:"captcha_sid",name:"captcha_sid",value:t.captchaCode}})]}));var r=BX.create("form",{props:{id:"bx-catalog-subscribe-form"},children:[BX.create("input",{props:{type:"hidden",name:"manyContact",value:i}}),BX.create("input",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("input",{props:{type:"hidden",name:"itemId",value:this.elemButtonSubscribe.dataset.item}}),BX.create("input",{props:{type:"hidden",name:"landingId",value:this.landingId}}),BX.create("input",{props:{type:"hidden",name:"siteId",value:BX.message("SITE_ID")}}),BX.create("input",{props:{type:"hidden",name:"contactFormSubmit",value:"Y"}})]});return r.appendChild(o),r},t.JCCatalogProductSubscribe.prototype.selectContactType=function(e,s){var a=BX("bx-catalog-subscribe-form-container-"+e),i="",o=BX("bx-contact-checkbox-"+e);if(!a)return!1;if(o!=s.target&&(o.checked?o.checked=!1:o.checked=!0),a.currentStyle)i=a.currentStyle.display;else if(t.getComputedStyle){i=t.getComputedStyle(a,null).getPropertyValue("display")}"none"===i?(BX("bx-contact-use-"+e).value="Y",BX.style(a,"display","")):(BX("bx-contact-use-"+e).value="N",BX.style(a,"display","none"))},t.JCCatalogProductSubscribe.prototype.createSuccessPopup=function(t){this.initPopupWindow(),this.elemPopupWin.setTitleBar(BX.message("CPST_SUBSCRIBE_POPUP_TITLE"));var e=BX.create("DIV",{props:{className:"bx-catalog-subscribe-alert"},children:[BX.create("span",{props:{className:"alert alert-success alert-show"},html:t.message})]});this.elemPopupWin.setContent(e),this.elemPopupWin.setButtons(!1),this.elemPopupWin.show()},t.JCCatalogProductSubscribe.prototype.initPopupWindow=function(){this.elemPopupWin=BX.PopupWindowManager.create("CatalogSubscribe_"+this.buttonId,null,{autoHide:!1,offsetLeft:0,offsetTop:0,overlay:{opacity:100},closeByEsc:!0,titleBar:!0,closeIcon:!0,className:"bx-catalog-subscribe-popup-window",contentColor:"white"});var t=BX.findChild(BX("CatalogSubscribe_"+this.buttonId),{className:"popup-window-close-icon"},!0,!1);t&&(t.innerHTML="<i class='icon-close'></i>")},t.JCCatalogProductSubscribe.prototype.setButton=function(t){this.alreadySubscribed=Boolean(t),this.alreadySubscribed?(BX.adjust(this.elemButtonSubscribe,{props:{disabled:!0,title:BX.message("CPST_TITLE_ALREADY_SUBSCRIBED")},html:"<i class='icon-mail'></i><span>"+BX.message("CPST_TITLE_ALREADY_SUBSCRIBED")+"</span>"}),BX.unbind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler)):(BX.adjust(this.elemButtonSubscribe,{props:{disabled:!1,title:BX.message("CPST_SUBSCRIBE_BUTTON_NAME")},html:"<i class='icon-mail'></i><span>"+BX.message("CPST_SUBSCRIBE_BUTTON_NAME")+"</span>"}),BX.bind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler))},t.JCCatalogProductSubscribe.prototype.showWindowWithAnswer=function(t){(t=t||{}).message||("success"==t.status?t.message=BX.message("CPST_STATUS_SUCCESS"):t.message=BX.message("CPST_STATUS_ERROR"));var e=BX.create("DIV",{props:{className:"bx-catalog-subscribe-alert"},children:[BX.create("span",{props:{className:"alert"+("success"==t.status?" alert-success":" alert-error")+" alert-show"},html:t.message})]}),s=BX.PopupWindowManager.getCurrentPopup();s&&s.destroy();var a=setTimeout(function(){var t=BX.PopupWindowManager.getCurrentPopup();t&&"bx-catalog-subscribe-status-action"==t.uniquePopupId&&(t.close(),t.destroy())},3500),i=BX.PopupWindowManager.create("bx-catalog-subscribe-status-action",null,{autoHide:!1,offsetLeft:0,offsetTop:0,overlay:{opacity:100},closeByEsc:!0,titleBar:!0,closeIcon:!0,className:"bx-catalog-subscribe-popup-window",contentColor:"white",onPopupClose:function(){this.destroy(),clearTimeout(a)}}),o=BX.findChild(BX("bx-catalog-subscribe-status-action"),{className:"popup-window-close-icon"},!0,!1);o&&(o.innerHTML="<i class='icon-close'></i>"),i.setTitleBar(BX.message("CPST_SUBSCRIBE_POPUP_TITLE")),i.setContent(e),i.setButtons(!1),i.show(),BX("bx-catalog-subscribe-status-action").onmouseover=function(t){clearTimeout(a)},BX("bx-catalog-subscribe-status-action").onmouseout=function(t){a=setTimeout(function(){var t=BX.PopupWindowManager.getCurrentPopup();t&&"bx-catalog-subscribe-status-action"==t.uniquePopupId&&(t.close(),t.destroy())},3500)}}}}(window);